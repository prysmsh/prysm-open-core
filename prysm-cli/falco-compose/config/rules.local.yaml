# Custom Falco rules live here.
# The default upstream ruleset is bundled with the falcosecurity/falco image.
# Use this file to add site-specific detections or to override defaults.

# Allow noisy health-check shells from the local Prysm stack.
- macro: prysm_healthcheck_shells
  condition: >
    container.image.repository in (postgres,
                                   "hashicorp/vault",
                                   "rancher/k3s",
                                   "docker.prysm.sh/prysm/dns-server",
                                   "docker.prysm.sh/prysm/warp-engine") and
    (
      proc.cmdline startswith "sh -c pg_isready" or
      proc.cmdline startswith "pg_isready" or
      proc.cmdline startswith "sh -c vault status" or
      proc.cmdline startswith "vault status" or
      proc.cmdline startswith "sh -c nslookup" or
      proc.cmdline startswith "nslookup" or
      proc.cmdline startswith "sh -c kubectl get nodes" or
      proc.cmdline startswith "kubectl get nodes" or
      proc.cmdline startswith "sh -c wget --quiet --tries=1 --spider http://localhost:8080/health" or
      proc.cmdline startswith "wget --quiet --tries=1 --spider http://localhost:8080/health" or
      proc.cmdline startswith "sh -c ping -c 1 vault" or
      proc.cmdline startswith "ping -c 1 vault"
    )

# Example: flag any interactive shell spawned inside a container.
- rule: Unexpected Container Shell
  desc: Detect interactive shells spawned in a container.
  condition: evt.type = execve and container and proc.name in (bash, sh, zsh, ash) and proc.pname != "falco" and not prysm_healthcheck_shells
  output: >
    Unexpected shell spawned inside container (user=%user.name container_id=%container.id
    container_name=%container.name image=%container.image.repository:%container.image.tag
    shell=%proc.name parent=%proc.pname cmdline=%proc.cmdline)
  priority: WARNING
  tags: [container, shell, mitre_execution]
